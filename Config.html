<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="refresh" content="3600">
	<style type="text/css" media="screen">
		@import "https://cine.no-ip.info/miestilo.css" screen;
	</style>
	<title>Configuración del ColorControl/Venus GX para la implementación del control de la carga de un coche eléctrico</title>
	<link rel="icon" type="image/gif" href="https://cine.no-ip.info/favicon.ico" />
</head>
<body lang=ES>
	<h1 align="center">Instrucciones de configuración</h1>
    <p>De cara a poder configurar nuestro ColorControl o Venus GX para poder usar el programa CargaCoche de cara a usar los excedentes 
    de nuestro sistema fotovoltaico para alimentar un coche eléctrico (o en su caso un termo o cualquier otro consumo eléctrico importante)
    es necesario dar unos pasos iniciales que vamos a relatar en este documento.</p>
    <p>Lo primero, es configurar una IP fija para nuestro sistema, ya sea un ColorControl o un Venus GX. Para esto se hace necesario
    el acceder también a nuestro router doméstico. Existe mucha documentación en la red al respecto del acceso a los routers de los 
    distintos operadores de Internet, por lo que no me voy a centrar en ello en este documento. Baste con saber que todos los routers 
    del mercado vienen configurados con <b>DHCP</b>, un protocolo que perite que cualquier equipo que se conecte a la red obtenga una 
    dirección IP de una lista de éstas que está configurada en el router. Si queremos que un equipo siempre tenga la misma dirección IP
    basta con hacer lo que se llama una <b>reserva de DHCP</b> en la configuración del router, de manera que siempre reciba la misma IP y nos 
    podamos conectar a él desde cualquier navegador usando siempre esa dirección. Normalmente los router suelen estar configurados 
    con la IP <b>192.18.1.1</b> y suelen empezar a dar direcciones por DHCP a partir de una dirección más alta, la .50 o similar.</p>
    <p>Para poder hacer una reserva de DHCP, necesitamos saber el nombre del equipo o su MAC (dirección física en un formato de 6 cifras
    hexadecimales de 2 dígitos, al estilo de 8a:bc:de:12:34:56). En el caso del Venus o el ColorControl, la información de la MAC está 
    en una etiqueta que viene pegada al equipo. También si tenemos activado el punto Wifi que incluyen, en el nombre las últimas 3 cifra se
    corresponden con los últimos 3 dígitos de la MAC, por ejemplo, en mi caso la Wifi es algo similar a venus-HQxxxxDABRK-ABC y éste ABC 
    se corresponde con los últimos dígitos de la MAC, facilitando el encontrarlo entre los dispositivos que están conectados a nuestro router
    para facilitar el asignarles una reserva DHCP, en mi caso está configurado en la IP <b>.12</b> (omitiré el resto de la dirección tipo 192.168.1. 
    a partir de ahora ya que dependerá de la configuración de la red de cada uno).</p>
    <p>Los siguientes pasos con respecto a la configuración de nuestro equipo es habilitar el ponernos como superusuarios para poder 
    habilitar el acceso por SSH y la clave de root. Para ello hemos de ir al menú de configuración del equipo. Allí puede que nos aparezca 
    en nivel de acceso <b>Usuario</b> o <b>Usuario e Instalador</b> y necesitamos ponerlo en modo <b>Superusuario</b>, para ello, hemos de 
    dejar pulsado el botón a la derecha unos segundos y entonces nos aparecerá la opción de <b>Superusuario</b>. Una vez elegida, nos 
    aparecerá debajo de ella la opción de poner la clave de root y habilitar el SSH en LAN. como en la imagen siguiente:</p>
    <p align="center"><img src="https://cine.no-ip.info/imagenes/Superusuario.png"></p>
    <p>En la parte del <b>Set root password</b> que cada cual ponga la que prefiera. <i>Es importante tener en cuenta que cuando se 
    actualice nuestro equipo esta clave se resteará, por lo que para poder volver a conectarnos tendremos que establecerla de nuevo.</i></p>
    <p>Salimos de la configuración General y dentro de configuración, casi en la parte más baja de la lista tenemos la opción de servicios,
    donde deberemos de habilitar las dos opciones de <b>MQTT</b>, aunque en principio la usaremos solo en modo <p>Texto simple</b>,
    pero es posible que en breve usemos la opción SSL.</p>
    <p align="center"><img src="https://cine.no-ip.info/imagenes/Servicios.png"></p>
    <p>Una vez realizado ésto, ya tenemos la primera parte de la configuración de nuestro equipo realizada. Al menos la parte de 
    configuración que podemos realizar desde la consola, en modo remoto en el Venus Gx o directamente en la pantalla en el caso del 
    ColorControl.</p>
    <p>Para configurar el SonOff Dual R2, lo primero es <a href="https://tasmota.github.io/docs/devices/Sonoff-Dual-R2/" target="_blank">tasmotizarlo</a>, 
    lo que si requiere de unos conocimientos un poco más avanzados aunque mínimos.</p>
    <p>Una vez realizado este proceso, lo siguiente es asignarle también una IP fija en nuestro router de manera similar a como lo
    hicimos con nuestro Venus o ColorControl GX, para ello hemos de averiguar la MAC de nuestro SonOff o al menos parte de ella.
    Cuando lo <i>tasmotizamos</i> al arrancar se pondrá por defecto en modo AP y mostrará parte de la MAC al final del nombre del
    SSID de la Wifi, por lo que con eso nos debería de bastar para localizarlo en nuestro router y asignarle otra IP, digamos 
    que será la <b>.13.</b></p>
    <p>Una vez hecho, nos conectamos con un navegador al SonOff, entramos en <b>Configuración, Recuperar Configuración</b> y elegimos el fichero
    <i>Config_CargaCoche_11.0.0.dmp</i> (es posible que este fichero cambie de nombre a medida que vayamos actualizando la versión
    del Tasmota en el SonOff, actualmente en la versión 11.0.0) y le damos a <b>Start Restore</b>.</p>
    <p align="center"><img src="https://cine.no-ip.info/imagenes/ConfigSonOff.png"></p>
    <p>Después de esto el equipo se reiniciará en unos segundos y ahora solo tendremos que volver al menú de <b>Configuración, MQTT</b>,
    y en el campo <b>host</b> poner la IP que le asignamos a nuestro Venus/ColorControl, en nuestro caso la .12.</p>
    <p>Con estos pasos terminamos la parte <i>sencilla</i> de configuración donde principalmente hemos usado los interfases de usuario
    de nuestros dispositivos para su configuración. Ahora ya tenemos que meternos en modo <i>comando</i> dentro de nuestro equipo
    para cargar el programa, sus librerías y asegurarnos de que arranca de nuevo cuando Victron manda una actualización a nuestros 
    equipos y causa el reinicio de éstos.</p>
    <p>Para esta parte es necesario usar un programa para poder acceder por ssh a nuestro equipo. Si eres novato, el 
    <a href="https://mobaxterm.mobatek.net/" target="_blank">MobaXterm</a> puede ser un buen comienzo, ya que nos facilitará la copia 
    de ficheros desde nuestro PC al equipo.<p>
    <p>Lo primero, tendremos también que usar un editor dentro del equipo. Para ello recomiendo el <i>nano</i> que viene instalado 
    en el Venus OS y que nos facilitará la vida. Empezaremos editando el fichero .bashrc que hay un nuestra carpeta /home/root que es
    nuestro <i>home</i>. Tenemos que irnos al final de dicho fichero y añadir las siguientes líneas:</p>
    <code>
    export Victron=<i>nuestroid</i><br />
    export PYTHONPATH=~/lib<br />
    export VISUAL=nano
    </code>
    <p>Salimos del nano sencillamente con un <i>Ctrl + x, 'y' y enter</i>.</p>
    <p>La variable Victron es el identificador de nuestro sistema y lo podemos sacar de la consola web en la opción de <b>Ajustes, General</b>.</p>
    <p align="center"><img src="https://cine.no-ip.info/imagenes/VictronID.png"></p>
    <p>Lo segundo es crear la carpeta <i>lib</i> en nuestro home y copiar allí el programa <i>CargaCoche2.py</i>, el fichero de 
    configuración, <i>config.py</i>, y también el <i>pytz.tgz</i> que los tenemos en el repositorio del git de donde supongo estas leyendo 
    este fichero. Una vez copiados, procedemos a descomprimir la librería pytz usando desde la carpeta lib el comando <code>tar xzvf pytz.tgz</code>. 
    Ésto nos creará una carpeta llamada pytz en lib. Después podemos proceder a eliminar el fichero pytz.tgz.</p>
    <p>Ahora nos queda configurar los parámetros en el fichero config.py, para lo cual volveremos a usar el nano.</p>
    <p>El fichero de configuración por defecto contiene esta información:</p>
    <pre>
    # -*- coding: utf-8 -*-
    """ Configuración de variables del sistema
    """
    # Referencia interna de nuestra instalación, necesaria para conocer el estado de la batería y del consumo
    VictronInterna = 'nuestraID'
    # Dirección IP del Venux/ColorControl GX en caso de que el programa se use en otro equipo. En caso contrario dejar el actual
    Venus = 'localhost'
    # Dirección de Email a donde mandar los correos de estado
    Email = 'NuestroCorreo@electronico.com'
    # Clave del correo
    Clave = "nuestraclave"
    # Hora de comienzo
    Inicio = 10
    # Hora de final de carga FV
    Final = 19
    # Hora de inicio de carga de Red
    InicioRed = 0
    # Hora de finalización de carga de Red que coincide con fin tarifa valle
    FinalRed = 8
    # Potencia pico que no se quiere sobrepasar. En nuestro caso, la que da el inversor de las baterías y al que sumaremos la que dan las placas
    PotenciaMax = 4500
    # Potencia que usa el PR
    PotenciaPR = 3000
    # Potencia mínima cuando usamos el PR. Para que corte en caso de considerar que el coche ya no está cargando
    PotenciaMinPR = 500
    # Potencia que produce la FV mínima para que nos salga a cuenta conectar el coche y no nos limitemos a ciclar la batería
    PotenciaFVMin = 400
    # Margen de batería (%) sobre el SOC Mínimo para comenzar la carga
    Margen = 30
    </pre>
    <p>Aquí hemos de poner de nuevo el Identificador Victron de nuestro sistema, la dirección de correo electrónico que vamos a usar para mandar 
    y recibir los mensajes y la clave de dicha cuenta. En el caso de las cuentas de Gmail, hay que usar una contraseña de aplicación. Puedes buscar
    más información sobre ello en el propio Google. En el caso de otros proveedores de correo supongo que cada uno establecerá su método.</p>
    <p>Las variables de InicioRed y FinalRed se usan para cuando activamos la carga nocturna directamente de la red, por defecto fijada en el
    periodo valle establecido actualmente en la tarifa genérica, de 0 a 8 horas.</p>
    <p>Por otro lado tenemos la potencia máxima a usar cuando estemos cargando de la fotovoltaica. Esto dependerá del inversor que tengas montado
    para manejar las baterías. La idea es que no sobrepase lo que el inversor puede dar más lo que esté suministrando la fotovoltaica, 
    de manera que no tengamos que tirar de la calle para cargar el coche si metemos en nuestra casa otra carga importante.</p>
    <p>También tenemos la potencia estimada de carga de nuestro adaptador schuko o wallbox, en mi caso adaptador schuko de 14A, y también el
    consumo mínimo que calculamos que puede usar nuestro adaptador de carga. Ésto se usa para desconectarlo si tenemos activada la carga y 
    detectamos que no se está llegando a la potencia definida. En ese caso asumimos que o no hay coche enchufado o ya se ha cargado completamente
    por lo que desconectamos la carga.</p>
    <p>Así mismo, la PotenciaFVMin también nos sirve para decidir que si está entrando menos de esa potencia de las placas, no activemos la carga, 
    puesto que solo estamos descargando la batería y eso contribuye a su deterioro.</p>
    <p>Por último, en margen es la cantidad de batería que descargamos para cargar el coche, de manera que nos aseguremos de que tenemos 
    batería para aguantar el consumo del resto de la casa al menos hasta llegar de nuevo al horario valle (las 12 de la noche). En mi caso, con
    una batería de 5 kWh, asumimos que con un 70% de SOC (estado de carga) podemos aguantar sin problemas.</p>
    <p>Una vez hemos configurado estos parámetros a nuestro gusto, nos queda un último paso. Y es configurar el arranque automático de nuestro 
    programa cuando venga una actualización del Venus OS, que causa un reinicio del equipo. Para ello hemos de crear un fichero llamado rcS.local
    en /data que contenga lo siguiente:</p>
    <pre>
    #!/bin/sh
    screen -AdmL -Logfile /home/root/lib/Carga.log -S CargaCoche -h 20000 /home/root/lib/CargaCoche2.py
    exit 0
    </pre>
    <p>De esa manera, el programa de control de la carga volverá a arrancar cuando el equipo se reinicie.</p>
    <p>Si todo ha ido bien, solo tendremos ahora que arrancar nuestro programa usando justamente la segunda línea anterior:</p>
    <p><i>screen -AdmL -Logfile /home/root/lib/Carga.log -S CargaCoche -h 20000 /home/root/lib/CargaCoche2.py</i></p>
    <p>Esto hace que se cree como otra sesión (screen) donde se ejecuta el programa y saca los mensajes de estado. Para ver si ha ido bien, 
    nos basta con poner el comando <i>tail -60 /home/root/lib/Carga.log</i>. Esto nos mostrará las últimas 60 líneas del fichero de log 
    donde el programa manda sus mensajes. Espera unos segundos después de lanzar el programa antes de ejecutarlo pues tarda un poco
    en establecer todas las comunicaciones y empezar a mostrar información. Debería de mostrar algo similar a ésto:</p>
    <pre>
    19/03/2022 14:46:33 Arrancamos el Control de Carga
    19/03/2022 14:46:35 SOC Mínimo 69%, Relé1 = False, Relé2 = False, carga = True, flag = False, cargaRed = False, batería 84%, consumo 310W, FV: 376W, PulseTime2: 0s, ACS: 0, ACSPulse: 0, {'Mem2': '69'}
    19/03/2022 14:46:35 SOC Mínimo 69%, Relé1 = False, Relé2 = False, carga = True, flag = False, cargaRed = False, batería 84%, consumo 310W, FV: 376W, PulseTime2: 0s, ACS: 0, ACSPulse: 0, {'Var3': '0'}
    19/03/2022 14:46:36 SOC Mínimo 69%, Relé1 = False, Relé2 = False, carga = 1, flag = False, cargaRed = False, batería 84%, consumo 310W, FV: 376W, PulseTime2: 0s, ACS: 0, ACSPulse: 0, {'Mem1': '1'}
    19/03/2022 14:46:36 SOC Mínimo 69%, Relé1 = False, Relé2 = False, carga = 1, flag = False, cargaRed = False, batería 84%, consumo 310W, FV: 376W, PulseTime2: 0s, ACS: 0, ACSPulse: 0, {'PulseTime2': {'Set': 0, 'Remaining': 0}}
    </pre>
    <p>La última información que va entre {} son los mensajes que le han llegado a traés del MQTT y que ha procesado. Al principio 
    sencillamente comprueba el estado de algunas variables que se almacenan en el propio SonOff</p>
</body>
</html>
    